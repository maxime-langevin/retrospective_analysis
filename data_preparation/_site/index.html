<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Data preparation</title>

<script src="site_libs/header-attrs-2.18/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Data preparation</h1>

</div>


<p>CHANGER AJUSTEMENT ? : NE PAS TOUCHER A REALITY, JUSTE CHANGER
REALITY REPORT ET SCENARIOS</p>
<p>ENREGISTRER REALITY, LA COMBINAISON DE TOUS LES SCENARIOS</p>
<p>MIEUX DE PRENDRE LE med = (max+min)/2 que le vrai med, pose problème
quand bcp de scénarios multipliés ?</p>
<p>This notebook prepares the data used in our analyses.</p>
<p>The first paragraph <em>Prepare reality data</em> focuses on true
data of Intensive Care Units (ICU) and Hospitalizations. Most of it is
from one of Pasteur Institutes’s team paper (<a
href="https://www.pnas.org/doi/abs/10.1073/pnas.2103302119">Paireau et
al 2022</a>), which has its own cleaning and smoothing process of the
government raw data. This dataset stops on July 2021. Beyond this date
we use data from multiple sources (Pasteur Institue’s subsequent
reports, government data) and combine them all to produce one unique and
coherent dataset.</p>
<p>Since Pasteur Institute’s scenarios data were not public, we had to
extract them manually from the reports figures, using <a
href="https://apps.automeris.io/wpd/">WebPlotDigitizer</a>. The process
for each report is described in the <em>Prepare Scenarios ICU</em> and
<em>Prepare Scenarios Hospitalizations</em> paragraphs. For each report
we indicate its original URL source. Then :</p>
<ul>
<li>In the <em>Original</em> tab, we provide the screenshot of the
original scenarios figures from which data are extracted.</li>
<li>In the <em>Reproduced</em> tab, we reproduce the original figures
from our extracted data. In some rare cases, we horizontally or
vertically offset the data for better alignment, based on comparison to
reality data before report publication.</li>
<li>EST CE QUE JE LAISSE LE ERROR TAB ??</li>
</ul>
<pre class="r"><code>f_compute_error &lt;- function(date_begin, date_end, dataset, normalization_figure){
  #dates delimiting the comparison period
  date_min &lt;- as.Date(date_begin)
  date_max &lt;- as.Date(date_end)
  #preparing file : gets date and true data value on the period
  reality_file &lt;- dataset %&gt;%
    select(date, reality) %&gt;%
    filter(date&gt;date_min &amp; date&lt;date_max)
  #computing min, med and max of scenarios
  temp &lt;- dataset %&gt;% 
    select(-reality, -reality_report) %&gt;%
    rowwise() %&gt;%
    mutate(
      med = median(c_across(-date), na.rm=T),
      min = min(c_across(-date), na.rm=T),
      max = max(c_across(-date), na.rm=T)
    )
  #joins 2 files
  reality_file &lt;- inner_join(reality_file, temp, by=&quot;date&quot;)
  reality_file &lt;- reality_file %&gt;%
    mutate(
      error_min = round((min-reality)/normalization_figure*100, 1),
      error_med = round((med-reality)/normalization_figure*100, 1),
      error_max = round((max-reality)/normalization_figure*100, 1)
    ) %&gt;%
  #remove infinite values (when min med and max applied to NAs)
    filter(
      !(is.infinite(min) | is.infinite(med) | is.infinite(max))
    )
  
  return (reality_file)
}</code></pre>
<pre class="r"><code>f_graph &lt;- 
  function(
    true_data, scenarios, variable, 
    x_label_publication, y_label_publication,
    x_min, x_max, y_max,
    str_y, str_reality
  ){
    modellers_true_data &lt;- scenarios %&gt;%
      select(date, reality)
    
    scenarios &lt;- scenarios %&gt;%
      select(-reality) %&gt;%
      gather(key=scenario, value = value, -date)

    
    p &lt;- ggplot(data = scenarios) + 
      #scenarios lines
      geom_line(
        aes(
          x=date, y=value, 
          group=scenario, color=&quot;scenarios&quot;
        ),
        size = 1
      ) + 
      #reality line
      geom_line(
        data= true_data, 
        aes(
          x=date, y=!!as.symbol(variable), 
          color = str_reality
          ),
        size = 1
        ) +
      #modellers reality line
      geom_point(
        data = modellers_true_data,
        aes(
          date, reality, color = &quot;reality in report&quot;
          ) 
      ) +
      #publication date line and label
      geom_vline(
        xintercept = as.Date(x_label_publication), linetype=&quot;dashed&quot;
      ) +
      annotate(
        &#39;text&#39;, x = as.Date(x_label_publication)-1, y = y_label_publication, label = &quot;publication\ndate&quot;, 
        color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, hjust=1
      ) +
      # x and y limits
      xlim(as.Date(x_min), as.Date(x_max)) + ylim(0, y_max) + 
      g_theme +
      labs(
        title = &quot;&quot;,
        subtitle = &quot;&quot;,
        color=&quot;&quot;,
        x=&quot;&quot;, y= str_y
        )
    
    return(p)
  }</code></pre>
<pre class="r"><code>f_offset &lt;- function(dataset_scenarios, dataset_reality, variable_select){
  #reality 
  temp_reality &lt;- dataset_reality %&gt;% select(date, reality = !!as.symbol(variable_select))
  temp_reality$date &lt;- temp_reality$date + x_reality_offset #on date (x)
  temp_reality$reality &lt;- temp_reality$reality + y_reality_offset #on values (y)
  
  #reality in report
  temp_reality_report &lt;- dataset_scenarios %&gt;% select(date, reality_report = reality)
  
  #scenarios offset
  temp_scenarios &lt;- dataset_scenarios %&gt;% select(-reality)
  temp_scenarios$date &lt;- temp_scenarios$date + x_scenarios_offset #on dates (x)
  temp_scenarios[,-1] &lt;- lapply(temp_scenarios[,-1], function(x) x+y_scenarios_offset) #on values (y)
  
  temp &lt;- full_join(temp_scenarios, temp_reality_report, by=&quot;date&quot;)
  temp &lt;- left_join(temp, temp_reality)
  
  return(temp)
}</code></pre>
<pre class="r"><code>f_graph_corrected &lt;- 
  function(
    scenarios, 
    x_label_publication, y_label_publication,
    x_min, x_max, y_max,
    str_y, str_reality
  ){
    modellers_true_data &lt;- scenarios %&gt;%
      select(date, reality_report)
    
    true_data &lt;- scenarios %&gt;%
      select(date, reality)
    
    scenarios &lt;- scenarios %&gt;%
      select(-reality, -reality_report) %&gt;%
      gather(key=scenario, value = value, -date)

    
    p &lt;- ggplot(data = scenarios) + 
      #scenarios lines
      geom_line(
        aes(
          x=date, y=value, 
          group=scenario, color=&quot;scenarios&quot;
        ),
        size = 1
      ) + 
      #reality line
      geom_line(
        data= true_data, 
        aes(
          x=date, y=reality, 
          color = str_reality
          ),
        size = 1
        ) +
      #modellers reality line
      geom_point(
        data = modellers_true_data,
        aes(
          date, reality_report, color = &quot;reality in report&quot;
          ) 
      ) +
      #publication date line and label
      geom_vline(
        xintercept = as.Date(x_label_publication), linetype=&quot;dashed&quot;
      ) +
      annotate(
        &#39;text&#39;, x = as.Date(x_label_publication)-1, y = y_label_publication, label = &quot;publication\ndate&quot;, 
        color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, hjust=1
      ) +
      # x and y limits
      xlim(as.Date(x_min), as.Date(x_max)) + ylim(0, y_max) + 
      g_theme +
      labs(
        title = &quot;&quot;,
        subtitle = &quot;&quot;,
        color = &quot;&quot;,
        x=&quot;&quot;, y= str_y
        )
    
    return(p)
  }</code></pre>
<pre class="r"><code>f_graph_error &lt;- function(
    dataset, x_label, y_label
    ){
  ggplot(dataset, aes(date)) + 
  geom_line(aes(y=error_med)) +
  geom_ribbon(aes(ymin = error_min, ymax = error_max), alpha = 0.1) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept=as.Date(x_label), linetype=&quot;dashed&quot;) +
  annotate(
    &#39;text&#39;, x = as.Date(x_label)-1, y = y_label, label = &quot;publication\ndate&quot;, 
    color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, hjust=1
  ) +
  labs(
    x=&quot;&quot;, y=&quot;error as % of 1st wave peak&quot;,
    title = &quot;Median, min and max relative errors of scenarios vs reality&quot;,
    subtitle = &quot;line: median scenario ; area: min and max scenarios&quot;
  )
}</code></pre>
<div id="prepare-data" class="section level1">
<h1>Prepare Data</h1>
<div id="prepare-reality-data"
class="section level2 tabset tabset-fade tabset-pills">
<h2 class="tabset tabset-fade tabset-pills">Prepare reality data</h2>
<div id="sources" class="section level3">
<h3>Sources</h3>
<p>Most of our reality data is based on <a
href="https://www.pnas.org/doi/abs/10.1073/pnas.2103302119">Paireau et
al (2022)</a> paper, which gives us the data up to July 2021.</p>
<pre class="r"><code>true_data_Paireau_et_al &lt;- readRDS(&quot;source_data/reality_Paireau_2022_paper/full_data.rds&quot;) %&gt;%
  filter(
    region == &quot;metropolitan&quot; #only metropolitan France
    ) %&gt;%
  select(
    date, 
    new_hosp = iHosp, #new hospitalizations
    new_hosp_smooth=iHosp_smooth, #new hospitalizations smoothed
    ICU_beds = inICU_smooth #ICU beds smoothed
    ) %&gt;%
  distinct()

#the &quot;smooth&quot; data is reported multiple time for each date, so we synthesize it
true_data_Paireau_et_al &lt;- true_data_Paireau_et_al %&gt;%
  group_by(date) %&gt;%
  summarise_all(mean, na.rm=T) %&gt;%
  mutate_all(round, 0)</code></pre>
<p>Beyond July 2021, for Intensive Care Units (ICU) data, we load the
the reported data on data.gouv, on <a
href="https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/">this
page</a>. We then combine it with Paireau et al data.</p>
<pre class="r"><code>#download data related to ICU Beds
data_gouv_beds_hosp_rea &lt;- 
  read_csv2(
    &quot;source_data/reality_data_gouv/covid-hospit-2023-03-31-18h01.csv&quot;
    ) %&gt;%
  mutate(date = as.Date(jour))

#Beds : critical car beds, hospitalization beds and conventional hospitalization beds
true_data_beds_hosp_rea &lt;- data_gouv_beds_hosp_rea %&gt;%
  filter(
    # 0 = men + women, 1 = men, 2 = women ; select 0, remove 1 and 2
    sexe ==&quot;0&quot;,
    #remove overseas territories
    dep != 971 &amp; dep != 972 &amp; dep != 973 &amp; dep != 974 &amp; dep != 976 &amp; dep != 978,
    #last scenario stops on Avril 2022, we do not keep the data beyond this point
    date &lt;= as.Date(&quot;2022-04-01&quot;)
    ) %&gt;%
  #group all departments together to have national data
  group_by(date) %&gt;% 
  dplyr::summarise(
    ICU_beds = sum(rea, na.rm = T)
    )

#Beds for April 28, 2020 scenario : only region Ile-de-France
true_data_beds_hosp_rea_IDF &lt;- data_gouv_beds_hosp_rea %&gt;%
  filter(
    # 0 = men + women, 1 = men, 2 = women ; select 0, remove 1 and 2
    sexe ==&quot;0&quot;, 
    # select region Ile-de-France departments
    dep %in% c(75, 92, 93, 94, 91, 95, 78, 77),
    #last scenario stops on Avril 2022, we do not keep the data beyond this point
    date &lt;= as.Date(&quot;2022-04-01&quot;)
    ) %&gt;% 
  #group all departments 
  group_by(date) %&gt;% 
  dplyr::summarise(
    ICU_beds = sum(rea, na.rm = T)
    ) </code></pre>
<p>For hospital admissions, the Paireau et al use a smoothing process.
This processed data is reported only up to July 2021. Beyond this date,
we manually extract the data from the subsequent Pasteur reports, using
<a href="https://apps.automeris.io/wpd/">WebplotDigitizer</a>.</p>
<pre class="r"><code>#load Pasteur reports data on new admissions
path_source &lt;- &quot;source_data/reality_reports_hosp_adm/&quot;
f_read &lt;- function(scenario_date){
  temp &lt;- read_csv(paste0(path_source, scenario_date, &quot;.csv&quot;)) %&gt;%
    mutate(scenario = gsub(&quot;_&quot;, &quot;-&quot;, scenario_date))
}
#combine the different data on hospital admissions
true_data_new_hosp_Pasteur_reports &lt;- bind_rows(
  f_read(&quot;2021_05_21&quot;),
  f_read(&quot;2021_07_27&quot;),
  f_read(&quot;2021_08_05&quot;),
  f_read(&quot;2021_10_04&quot;),
  f_read(&quot;2021_12_17&quot;),
  f_read(&quot;2022_02_15&quot;) %&gt;% 
    #for the January 2022 period the smoothed admissions is not reported, so we compute it
    mutate(
      new_hosp_smooth=rollmean(new_hosp, 7, na.pad = T, align = &quot;right&quot;)
      )
  )</code></pre>
</div>
<div id="datasets-combinations"
class="section level3 tabset tabset-fade">
<h3 class="tabset tabset-fade">Datasets combinations</h3>
<div id="icu" class="section level4">
<h4>ICU</h4>
<p>For ICU beds, data from Paireau et al. and from data.gouv match very
well on their common period until July 2021, so after this date we use
the data.gouv data (just with a 2-day offset to better align). The
difference between the 2 datasets is typically less than 1%.</p>
<pre class="r"><code>day_offset &lt;- -2

#combine Paireau and data.gouv datasets
reality_ICU_beds &lt;- bind_rows(
  #Paireau dataset before July 2021
  true_data_Paireau_et_al %&gt;% 
    select(date, ICU_beds) %&gt;%
    filter(date&lt;as.Date(&quot;2021-07-01&quot;)),
  #data.gouv dataset after July 2021, with a negative 2-day offset
  true_data_beds_hosp_rea %&gt;% 
    select(date, ICU_beds) %&gt;% 
    mutate(date = date + day_offset) %&gt;%
    filter(date&gt;=as.Date(&quot;2021-07-01&quot;))
)
#maximum ICU beds occupancy reached, for normalization further in the code
max_ICU_beds &lt;- max(reality_ICU_beds$ICU_beds, na.rm=T)

#Ile-de-France data for first scenarios (April 2020), based on data.gouv data and with the 2-day offset
reality_ICU_beds_IDF &lt;- true_data_beds_hosp_rea_IDF %&gt;%
  mutate(date = date+day_offset)
max_ICU_beds_IDF &lt;- max(reality_ICU_beds_IDF$ICU_beds, na.rm=T)

#plot the 2 datasets and their combination to see the negligible discrepancies
ggplot(true_data_Paireau_et_al) +
  #data.gouv
  geom_line(
    data =true_data_beds_hosp_rea, linewidth=2.5, alpha=.4,
    aes(date+day_offset, ICU_beds, color=&quot;data.gouv&quot;)
    ) +
  #Paireau et al
  geom_line(
    aes(date, ICU_beds, color=&quot;Paireau et al.&quot;),
    linewidth=2.5, alpha=.4,
    ) +
  #our true data
  geom_line(
    data=reality_ICU_beds, 
    aes(date, ICU_beds, linetype=&quot;combination\nused in this study&quot;)
    ) +
  #ICU beds capacity
  geom_hline(yintercept = max_ICU_beds, linetype=&quot;dashed&quot;) +
  labs(
    title = &quot;ICU beds occupied by COVID patients&quot;,
    subtitle = &quot;horizontal line: historical maximum occupancy of ICU beds during 1st wave&quot;,
    colour = &quot;&quot;,
    linetype = &quot;&quot;,
    y=&quot;COVID-related ICU beds occupancy&quot;,
    x=&quot;&quot;
  )</code></pre>
<p><img src="index_files/figure-html/ICU_datasets_combination-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#prepare data to see error
temp &lt;- 
  inner_join(
    true_data_Paireau_et_al %&gt;% 
      select(date, ICU_beds_Paireau=ICU_beds),
    true_data_beds_hosp_rea %&gt;% 
      select(date, ICU_beds_data_gouv=ICU_beds) %&gt;% 
      mutate(date=date+day_offset),
    by=&quot;date&quot;
    ) %&gt;%
  mutate(
    error=(ICU_beds_Paireau-ICU_beds_data_gouv),
    error_percent=(ICU_beds_Paireau-ICU_beds_data_gouv)/max_ICU_beds*100
    )

plot_grid(
  ggplot(temp) +
    geom_area(aes(date, error, fill=&quot;absolute error&quot;)) +
    geom_hline(yintercept = max_ICU_beds, linetype=&quot;dashed&quot;) +
    ylim(0, max_ICU_beds) +
    annotate(
        &#39;text&#39;, x = as.Date(&quot;2021-05-01&quot;), y = 6000, label = &quot;horizontal line:\nmax ICU beds occupancy&quot;, 
        color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, hjust=1
      ) +
    theme(legend.position = &quot;top&quot;) +
    labs(
      title = &quot;Error between the 2 ICU beds datasets&quot;,
      fill=&quot;&quot;,
      y=&quot;ICU beds&quot;,
      x=&quot;&quot;
    ),
  ggplot(temp) +
    geom_area(aes(date, error_percent, fill=&quot;relative error&quot;)) +
    ylim(0, NA) +
    theme(legend.position = &quot;top&quot;) +
    labs(
      title = &quot;&quot;,
      fill=&quot;&quot;,
      y=&quot;% of 1st wave peak&quot;,
      x=&quot;&quot;
    )
)</code></pre>
<p><img src="index_files/figure-html/error_comparison_ICU_beds-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="hospital-admissions" class="section level4">
<h4>Hospital admissions</h4>
<p>We cannot apply the same method for new hospital admissions, since
the modellers use a modified indicator not reported in data.gouv (see
details in <a
href="https://www.pnas.org/doi/abs/10.1073/pnas.2103302119">Paireau et
al 2022</a>. So for the period after July 2021, we have to extract the
true data of “new hospital admissions” from the different subsequent
reports, when it is reported.</p>
<pre class="r"><code>#graph of all sources
ggplot(true_data_new_hosp_Pasteur_reports) +
  #reports data new hospitalizations smoothed
  geom_line(
    aes(date, new_hosp_smooth, group=scenario, color=scenario), 
    linewidth=2
    ) +
  #reports data new hospitalizations 
  geom_point(
    aes(date, new_hosp, group=scenario, color=scenario), 
    alpha=.2
    ) +
  #Paireau et al data new hospitalizations smoothed 
  geom_line(
    data = true_data_Paireau_et_al, linewidth=1,
    aes(date, new_hosp_smooth, linetype=&quot;Paireau et al.&quot;)
    ) +
  #Paireau et al data new hospitalizations 
  geom_point(
    data = true_data_Paireau_et_al, alpha=.2,
    aes(date, new_hosp)
    ) +
  labs(
    x=&quot;&quot;, y=&quot;daily new hospital admissions&quot;,
    color=&quot;report source&quot;,
    linetype=&quot;&quot;,
    title = &quot;Datasets used for new hospital admissions&quot;
    )</code></pre>
<p><img src="index_files/figure-html/combine_data_on_hospitalizations-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#synthesize data from all reports
true_data_new_hosp_Pasteur_reports &lt;- true_data_new_hosp_Pasteur_reports %&gt;% 
  group_by(date) %&gt;% #because sometimes multiple values for 1 date
  summarise(
    new_hosp=round(mean(new_hosp, na.rm=T)),
    new_hosp_smooth=round(mean(new_hosp_smooth, na.rm=T))
    ) %&gt;%
  filter(date&gt;=as.Date(&quot;2021-07-01&quot;))
#replace all NAN by NA
true_data_new_hosp_Pasteur_reports &lt;- true_data_new_hosp_Pasteur_reports %&gt;% 
  mutate_all(~replace(., is.nan(.), NA))

#merge the 2 datasets
reality_new_hosp_adm &lt;- bind_rows(
  true_data_new_hosp_Pasteur_reports,
  true_data_Paireau_et_al %&gt;% 
    select(date, new_hosp_smooth, new_hosp) %&gt;%
    filter(date&lt;as.Date(&quot;2021-07-01&quot;))
)

#remove data not useful anymore
rm(
  data_gouv_beds_hosp_rea, true_data_beds_hosp_rea, true_data_beds_hosp_rea_IDF,
  true_data_Paireau_et_al, true_data_new_hosp_Pasteur_reports
  )</code></pre>
<p>Combining all the datasets together yields the following result,
after extrapolation on missing period (just 2 weeks in Nov-Dec 2021)
:</p>
<pre class="r"><code>#remove lines were new_hosp_smooth not reported
reality_new_hosp_adm &lt;- reality_new_hosp_adm %&gt;% filter(is.na(new_hosp_smooth)==F)

#extrapolate new hospitalizations on missing period in Nov-Dec 2021
date_min &lt;- &quot;2021-11-23&quot;
date_max &lt;- &quot;2021-12-07&quot;
ndays &lt;- as.numeric(as.Date(date_max) - as.Date(date_min))
#ndays &lt;- as.numeric(as.Date(&quot;2021-11-25&quot;) - as.Date(&quot;2021-11-23&quot;))
hosp_min &lt;- reality_new_hosp_adm$new_hosp_smooth[reality_new_hosp_adm$date==as.Date(date_min)]
hosp_max &lt;- reality_new_hosp_adm$new_hosp_smooth[reality_new_hosp_adm$date==as.Date(date_max)]

temp &lt;- data_frame(
  date = seq(from=as.Date(date_min), to=as.Date(date_max), by=&quot;day&quot;),
  new_hosp = NA,
  new_hosp_smooth = seq(from=hosp_min, to=hosp_max, by=(hosp_max-hosp_min)/(ndays))
) 
temp$new_hosp_smooth &lt;- round(temp$new_hosp_smooth)

#remove first and last rows (start and end days)
temp = temp[-1,]
temp = temp[-nrow(temp),]

#combine original data and extrapolation
reality_new_hosp_adm &lt;- bind_rows(
  reality_new_hosp_adm, 
  temp
)

#remove temporary variables
rm(date_min, date_max, ndays, hosp_min, hosp_max)

#plot the data
ggplot(reality_new_hosp_adm) +
  geom_line(aes(date, new_hosp_smooth)) +
  geom_line(aes(date, new_hosp), alpha=.4) +
  labs(
    title = &quot;New COVID-related hospital admissions&quot;
  )</code></pre>
<p><img src="index_files/figure-html/final_data_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="historical-maxima" class="section level4">
<h4>historical maxima</h4>
<p>In our analysis, we use the historical maxima of ICU beds occupancy
and hospital admissions to normalize the erro between scenarios and
reality.</p>
<pre class="r"><code>max_ICU_beds &lt;- max(reality_ICU_beds$ICU_beds, na.rm=T)
max_ICU_beds_IDF &lt;- max(reality_ICU_beds_IDF$ICU_beds, na.rm=T)
max_new_hosp &lt;- max(reality_new_hosp_adm$new_hosp_smooth, na.rm=T)</code></pre>
</div>
</div>
</div>
<div id="prepare-scenarios-icu" class="section level2">
<h2>Prepare Scenarios ICU</h2>
<pre class="r"><code>output_path &lt;- &quot;output_data/extracted_data/ICU_scenarios/&quot;
output_path_error &lt;- &quot;output_data/min_med_max_and_error/ICU_error/&quot;</code></pre>
<div id="april-28-2020"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">April 28, 2020</h3>
<p>Source: <a
href="https://www.lesechos.fr/idees-debats/editos-analyses/pourquoi-philippe-a-douche-les-francais-1199309">Les
Echos newspaper</a>, April 29, 2020. Specified “dated Tuesday”, so we
deduce that the publication dates from Tuesday April 28. Identified by
Google search.</p>
<div id="original" class="section level4">
<h4>Original</h4>
<p><img src="source_data/2020_04_28/2020_04_28.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="reproduced" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2020_04_28/ICU.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_ICU_beds_IDF, scenarios, 
  &quot;ICU_beds&quot;, 
  &quot;2020-04-28&quot;, 1000, #publication date label
  &quot;2020-03-19&quot;, &quot;2020-06-28&quot;, #date limits
  NA, # y limits
  &quot;ICU beds in Ile-de-France&quot;, #y axis label
  &quot;reality in data.gouv&quot; #reality label
)</code></pre>
<p><img src="index_files/figure-html/2020_04_28_Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(scenarios, reality_ICU_beds_IDF, &quot;ICU_beds&quot;)

f_graph_corrected(
  temp, 
  &quot;2020-04-28&quot;, 1000, #publication date label
  &quot;2020-03-19&quot;, &quot;2020-06-28&quot;, #date limits
  NA, # y limits
  &quot;Intensive care beds in Ile-de-France&quot;, 
  &quot;reality in data.gouv&quot;
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-1-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2020_04_28_ICU.csv&quot;))</code></pre>
</div>
</div>
<div id="error" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2020-03-29&quot;, &quot;2020-06-28&quot;, temp, max_ICU_beds_IDF)

f_graph_error(
  error,
  &quot;2020-04-28&quot;, 50 #publication date label
  ) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-2-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2020_04_28_ICU_error.csv&quot;))</code></pre>
</div>
</div>
<div id="october-30-2020"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">October 30, 2020</h3>
<p>Source: <a
href="https://www.lesechos.fr/economie-france/social/covid-la-decrue-dans-les-services-de-reanimation-esperee-en-france-dans-une-dizaine-de-jours-1261656">Les
Echos newspaper</a>, November 3, 2020. We know the publication date from
the statement “The scientists from Pasteur Institute and Santé Publique
France updated their epidemic scenarios on October 30”. Identified by
Google search.</p>
<p>checker la sortie du confinement</p>
<div id="orginal" class="section level4">
<h4>Orginal</h4>
<p><img src="source_data/2020_10_30/2020_10_30.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="reproduced-1" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment)</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-1" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2020_10_30/ICU.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_ICU_beds, scenarios, 
  &quot;ICU_beds&quot;, 
  &quot;2020-10-30&quot;, 5000, #publication date label
  &quot;2020-10-01&quot;, &quot;2020-12-15&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/2020_10_30-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-1" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_ICU_beds, 
  &quot;ICU_beds&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2020-10-30&quot;, 5000, #publication date label
  &quot;2020-10-01&quot;, &quot;2020-12-15&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-4-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#end of 2nd lockdown December 15, which is also the end of the scenarios
write_csv(temp, paste0(output_path, &quot;2020_10_30_ICU.csv&quot;))</code></pre>
</div>
</div>
<div id="error-1" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2020-10-01&quot;, &quot;2020-12-15&quot;, temp, max_ICU_beds)

f_graph_error(
  error,
  &quot;2020-10-30&quot;, 25 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2020_10_30_ICU_error.csv&quot;))</code></pre>
</div>
</div>
<div id="may-21-scenarios"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">May 21 Scenarios</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/loosening/Mise_a_jour_scenarios_de_levee_des_mesures_de_freinage_20210521.pdf">Pasteur
report</a>, May 21, 2021. Identified on Pasteur Institute’s website, on
<a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-1" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-3a" class="section level5">
<h5>fig 3A</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig3A.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-3c" class="section level5">
<h5>fig 3C</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig3C.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-3e" class="section level5">
<h5>fig 3E</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig3E.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-3g" class="section level5">
<h5>fig 3G</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig3G.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-2" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-2" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_05_21/ICU.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_ICU_beds, scenarios, 
  &quot;ICU_beds&quot;,
  &quot;2021-05-21&quot;, 1000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-06-30&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in Paireau et al.&quot;
) + ylim(0, 6100)</code></pre>
<p><img src="index_files/figure-html/2021_05_21_Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-2" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_ICU_beds %&gt;% select(date, ICU_beds), 
  &quot;ICU_beds&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-05-21&quot;, 1000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-06-30&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in Paireau et al.&quot;
) + ylim(0, 6100)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-7-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(
  temp %&gt;% filter(date&lt;=as.Date(&quot;2021-06-15&quot;)), #stop comparison mid-June before delta variant dominant
  paste0(output_path, &quot;2021_05_21_ICU.csv&quot;)
  )</code></pre>
</div>
</div>
<div id="error-2" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-03-15&quot;, &quot;2021-06-15&quot;, temp, max_ICU_beds)

f_graph_error(
  error,
  &quot;2021-05-21&quot;, 10 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_05_21_ICU_error.csv&quot;))</code></pre>
</div>
</div>
<div id="july-26-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">July 26, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/Institut_Pasteur_Acceleration_vaccination_et_Delta_20210726.pdf">Pasteur
report</a>, July 26, 2021. Identified on Pasteur Institute’s website, on
<a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-2" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-6" class="section level5 tabset tabset-fade">
<h5 class="tabset tabset-fade">Fig 6</h5>
<div id="zoomed" class="section level6">
<h6>zoomed</h6>
<pre class="r"><code>knitr::include_graphics(&quot;source_data/2021_07_26/fig6_zoom.png&quot;)</code></pre>
<p><img src="source_data/2021_07_26/fig6_zoom.png" width="236" style="display: block; margin: auto;" /></p>
</div>
<div id="all" class="section level6">
<h6>all</h6>
<p><img src="source_data/2021_07_26/2021_07_26_fig6.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="fig-5" class="section level5 tabset tabset-fade">
<h5 class="tabset tabset-fade">Fig 5</h5>
<div id="zoomed-1" class="section level6">
<h6>zoomed</h6>
<pre class="r"><code>knitr::include_graphics(&quot;source_data/2021_07_26/fig5_zoom.png&quot;)</code></pre>
<p><img src="source_data/2021_07_26/fig5_zoom.png" width="235" style="display: block; margin: auto;" /></p>
</div>
<div id="all-1" class="section level6">
<h6>all</h6>
<p><img src="source_data/2021_07_26/2021_07_26_fig5.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="reproduced-3"
class="section level4 tabset tabset-fade tabset-pills">
<h4 class="tabset tabset-fade tabset-pills">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better alignment).
The apparent discrepancy between the scenarios and reality before
publication date is not due to improper data extraction, but is present
in the modelers’ report (see <em>Original</em> tab, figure 6.)</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-3" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_07_26/ICU.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_ICU_beds, scenarios, 
  &quot;ICU_beds&quot;,
  &quot;2021-07-26&quot;, 5000, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
) </code></pre>
<p><img src="index_files/figure-html/2021_07_26_Pasteur_ICU_beds-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-3" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_ICU_beds, 
  &quot;ICU_beds&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-07-26&quot;, 5000, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2021_07_26_ICU.csv&quot;))</code></pre>
</div>
</div>
<div id="error-3" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-07-15&quot;, &quot;2021-10-10&quot;, temp, max_ICU_beds)

f_graph_error(
  error,
  &quot;2021-07-26&quot;, 100 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-13-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_07_26_ICU_error.csv&quot;))</code></pre>
</div>
</div>
<div id="august-5-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">August 5, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/InstitutPasteur_Dynamiques_regionales_des_hospitalisations_20210805.pdf">Pasteur
report</a>, August 5, 2021. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-3" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-f" class="section level5">
<h5>Fig F</h5>
<p><img src="source_data/2021_08_05/2021_08_05.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-4" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0 
y_scenarios_offset &lt;- 80</code></pre>
<div id="before-correction-4" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_08_05/ICU.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_ICU_beds, scenarios, 
  &quot;ICU_beds&quot;,
  &quot;2021-08-05&quot;, 5000, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
) </code></pre>
<p><img src="index_files/figure-html/2021_08_05_Pasteur_ICU_beds-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-4" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_ICU_beds, 
  &quot;ICU_beds&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-08-05&quot;, 5000, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-15-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2021_08_05_ICU.csv&quot;))</code></pre>
</div>
</div>
<div id="error-4" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-07-15&quot;, &quot;2021-10-10&quot;, temp, max_ICU_beds)

f_graph_error(
  error,
  &quot;2021-08-05&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-16-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_08_05_ICU_error.csv&quot;))</code></pre>
</div>
</div>
<div id="january-7-2022"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">January 7, 2022</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/InstitutPasteur_Complement_Analyse_Impact_Omicron_20220107_corrige.pdf">Pasteur
report</a>, January 7, 2022. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/omicron-variant-epidemic/">this
page</a>.</p>
<div id="original-4" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="figure-4-zoomed" class="section level5">
<h5>Figure 4 zoomed</h5>
<p><img src="source_data/2022_01_07/2022_01_07_SC_zoom.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="figure-4-all" class="section level5">
<h5>Figure 4 all</h5>
<p><img src="source_data/2022_01_07/2022_01_07_SC.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-5" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We apply just a 1 day offset on the scenarios date for better
alignement.</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- -1
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-5" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2022_01_07/ICU_low_VE.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))


f_graph(
  reality_ICU_beds, scenarios, 
  &quot;ICU_beds&quot;,
  &quot;2022-01-07&quot;, 1000, #publication date label
  &quot;2021-12-01&quot;, &quot;2022-04-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
)</code></pre>
<p><img src="index_files/figure-html/2022-01-07_ICU-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-5" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_ICU_beds, 
  &quot;ICU_beds&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2022-01-07&quot;, 1000, #publication date label
  &quot;2021-12-01&quot;, &quot;2022-04-01&quot;, #date limits
  NA, # y limits
  &quot;ICU beds&quot;, 
  &quot;reality in data.gouv&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-18-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2022_01_07_ICU.csv&quot;))</code></pre>
</div>
</div>
<div id="error-5" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-12-01&quot;, &quot;2022-04-01&quot;, temp, max_ICU_beds)

f_graph_error(
  error,
  &quot;2022-01-07&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-19-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2022_01_07_ICU_error.csv&quot;))</code></pre>
</div>
</div>
</div>
<div id="prepare-scenarios-hospitalizations" class="section level2">
<h2>Prepare Scenarios Hospitalizations</h2>
<pre class="r"><code>output_path &lt;- &quot;output_data/extracted_data/new_hosp_scenarios/&quot;
output_path_error &lt;- &quot;output_data/min_med_max_and_error/new_hosp_error/&quot;</code></pre>
<div id="january-16-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">January 16, 2021</h3>
<p>Source: <a
href="https://www.epicx-lab.com/uploads/9/6/9/4/9694133/inserm_covid-19-voc_dominance-20210116.pdf">INSERM/Pasteur
report</a>, January 16, 2021. Cited in the <a
href="https://sante.gouv.fr/IMG/pdf/note_eclairage_variants_modelisation_29_janvier_2021.pdf">January
29, 2021 report</a>, which was identified on Pasteur Institute’s
website, on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/impact-variant/">this
page</a>.</p>
<div id="original-5" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-1" class="section level5">
<h5>Fig 1</h5>
<p><img src="source_data/2021_01_16/2021_01_16.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-6" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-6" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_01_16/new_hosp_weekly.csv&quot;)
scenarios$date &lt;- paste0(scenarios$date, &quot;-4&quot;)
scenarios$date &lt;- ISOweek2date(scenarios$date)

#transform daily data to weekly data
temp2 &lt;- reality_new_hosp_adm %&gt;%
  select(date,new_hosp) %&gt;%
  mutate(
    date = ISOweek(date),
    date = ISOweek2date(paste0(date, &quot;-4&quot;))
    ) %&gt;%
  group_by(date) %&gt;%
  summarise(new_hosp = sum(new_hosp, na.rm=T)) 

f_graph(
  temp2, scenarios, 
  &quot;new_hosp&quot;, 
  &quot;2021-01-16&quot;, 1000, #publication date label
  &quot;2020-10-01&quot;, &quot;2021-05-01&quot;, #date limits
  NA, # y limits
  &quot;weekly hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/2021_01_16-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>  #confinement de 16 départements le 20 mars cf https://fr.wikipedia.org/wiki/Chronologie_de_la_pand%C3%A9mie_de_Covid-19_en_France
  #2 semaines pour voir les effets sur hospitalisations. correspond aussi au confinement général du 3 avril</code></pre>
</div>
<div id="after-correction-6" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  temp2, 
  &quot;new_hosp&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-01-16&quot;, 1000, #publication date label
  &quot;2020-10-01&quot;, &quot;2021-05-01&quot;, #date limits
  NA, # y limits
  &quot;weekly hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-21-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% 
  mutate(across(-c(date), function(x) x/7)) %&gt;% #weekly hosp transformed in daily hosp
  filter(date &lt;= as.Date(&quot;2021-03-22&quot;)) #stop comparison before 3rd lockdown, on March 22nd

#since only 1 point per week, we linearly extrapolate missing days
temp &lt;- left_join(
  #add missing days by join
  data_frame(date = seq(as.Date(min(temp$date)), max(temp$date), by=&quot;days&quot;)),
  temp, 
  by=&quot;date&quot;
  ) %&gt;%
  #linear extrapolation on missing values
  mutate(across(-date, ~na.approx(.x, na.rm=F)))

write_csv(temp, paste0(output_path, &quot;2021_01_16_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-6" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2020-10-01&quot;, &quot;2021-05-01&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-01-16&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-22-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_01_16_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="february-2-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">February 2, 2021</h3>
<p>Source: <a
href="https://www.epicx-lab.com/uploads/9/6/9/4/9694133/inserm-covid-19-voc-lockdown-20210202.pdf">INSERM/Pasteur
report</a>, February 2, 2021. Identified on Pasteur Institute’s website,
on <a href="">this page</a>.</p>
<div id="original-6" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-2" class="section level5">
<h5>Fig 2</h5>
<p><img src="source_data/2021_02_02/2021_02_02.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-7" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-7" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_02_02/new_hosp_weekly.csv&quot;)
scenarios$date &lt;- paste0(scenarios$date, &quot;-4&quot;)
scenarios$date &lt;- ISOweek2date(scenarios$date)

#transform daily data to weekly data
temp2 &lt;- reality_new_hosp_adm %&gt;%
  select(date,new_hosp) %&gt;%
  mutate(
    date = ISOweek(date),
    date = ISOweek2date(paste0(date, &quot;-4&quot;))
    ) %&gt;%
  group_by(date) %&gt;%
  summarise(new_hosp = sum(new_hosp, na.rm=T)) 

f_graph(
  temp2, scenarios, 
  &quot;new_hosp&quot;, 
  &quot;2021-02-02&quot;, 1000, #publication date label
  &quot;2020-10-01&quot;, &quot;2021-05-01&quot;, #date limits
  NA, # y limits
  &quot;weekly hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/2021_02_02_Inserm-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#confinement de 16 départements le 20 mars cf https://fr.wikipedia.org/wiki/Chronologie_de_la_pand%C3%A9mie_de_Covid-19_en_France
  #2 semaines pour voir les effets sur hospitalisations. correspond aussi au confinement général du 3 avril</code></pre>
</div>
<div id="after-correction-7" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  temp2, 
  &quot;new_hosp&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-02-03&quot;, 1000, #publication date label
  &quot;2020-10-01&quot;, &quot;2021-05-01&quot;, #date limits
  NA, # y limits
  &quot;weekly hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-24-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% mutate(across(-c(date), function(x) x/7)) %&gt;% #weekly hosp transformed in daily hosp
    filter(date &lt;= as.Date(&quot;2021-03-22&quot;)) #stop comparison before 3rd lockdown, on March 22nd

#since only 1 point per week, we linearly extrapolate missing days
temp &lt;- left_join(
  #add missing days by join
  data_frame(date = seq(as.Date(min(temp$date)), max(temp$date), by=&quot;days&quot;)),
  temp, 
  by=&quot;date&quot;
  ) %&gt;%
  #linear extrapolation on missing values
  mutate(across(-date, ~na.approx(.x, na.rm=F)))

write_csv(temp, paste0(output_path, &quot;2021_02_02_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-7" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2020-10-01&quot;, &quot;2021-05-01&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-02-02&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-25-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_02_02_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="february-8-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">February 8, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/RapportInstitutPasteur_variants_8fevrier2021.pdf">Pasteur
report</a>, February 8, 2021. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/impact-variant/">this
page</a>.</p>
<div id="original-7" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-2a" class="section level5">
<h5>Fig 2A</h5>
<p><img src="source_data/2021_02_08/2021_02_08_fig2.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-6a" class="section level5">
<h5>Fig 6A</h5>
<p><img src="source_data/2021_02_08/2021_02_08_fig6.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-7c" class="section level5">
<h5>Fig 7C</h5>
<p><img src="source_data/2021_02_08/2021_02_08_fig7.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-8" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We apply small -100 offset for the scenarios on the y axis for better
alignment. The apparent discrepancy between the scenarios and the
smoothed reality is not due to improper data extraction but is present
in the modellers’ report. Their scenarios matches the upper bound of the
unsmoothed hospital admissions (see <em>Original</em> tab), as in our
graph.</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- -100</code></pre>
<div id="before-correction-8" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_02_08/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;, 
  &quot;2021-02-08&quot;, 5000, #publication date label
  &quot;2021-01-01&quot;, &quot;2021-06-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
) +
  geom_line(
    data=reality_new_hosp_adm, aes(date, new_hosp), alpha=.4, color=&quot;red&quot;
  )</code></pre>
<p><img src="index_files/figure-html/2021_02_08_Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-8" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm %&gt;% select(date, new_hosp_smooth),
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-02-08&quot;, 5000, #publication date label
  &quot;2021-01-01&quot;, &quot;2021-06-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)  +
  geom_line(
    data=reality_new_hosp_adm, aes(date, new_hosp+y_reality_offset), alpha=.4, color=&quot;red&quot;
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-27-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#stop comparison before 3rd lockdown, on March 22nd
temp &lt;- temp %&gt;% filter(date &lt;= as.Date(&quot;2021-03-22&quot;)) 

write_csv(temp, paste0(output_path, &quot;2021_02_08_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-8" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-01-01&quot;, &quot;2021-03-27&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-02-08&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-28-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_02_08_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="february-23-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">February 23, 2021</h3>
<p>Source: <a
href="https://hal-pasteur.archives-ouvertes.fr/pasteur-03149525/document">Pasteur
report</a>, February 23, 2021. Identified on Pasteur Institute’s
website, on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/impact-variant/">this
page</a>.</p>
<div id="original-8" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-2c" class="section level5">
<h5>Fig 2C</h5>
<p><img src="source_data/2021_02_23/2021_02_23_fig2.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-5a-5c-and-5e" class="section level5">
<h5>Fig 5A, 5C and 5E</h5>
<p><img src="source_data/2021_02_23/2021_02_23_fig5.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-9" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better alignment).
Scenarios curves diverge from reality before publication date, but this
matches the modellers’ original report (see <em>Orginal</em> tab). In
their figure, reality data stops around mid-February, and scenarios
curves keep decreasing until at least the first week of March.</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-9" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>#February 23 2021
#besoin de réaligner leurs données sur la réalité (ne compte surement pas exactement la meme chose)
scenarios &lt;- read_csv(&quot;source_data/2021_02_23/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;, 
  &quot;2021-02-23&quot;, 3000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-07-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
) </code></pre>
<p><img src="index_files/figure-html/2021_02_23_Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>  #confinement de 16 départements le 20 mars cf https://fr.wikipedia.org/wiki/Chronologie_de_la_pand%C3%A9mie_de_Covid-19_en_France
  #2 semaines pour voir les effets sur hospitalisations. correspond aussi au confinement général du 3 avril</code></pre>
</div>
<div id="after-correction-9" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm %&gt;% select(date, new_hosp_smooth), 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-02-23&quot;, 3000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-07-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-30-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% filter(date &lt;= as.Date(&quot;2021-03-22&quot;)) #stop comparison before 3rd lockdown, on March 22nd

write_csv(temp, paste0(output_path, &quot;2021_02_23_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-9" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-01-16&quot;, &quot;2021-03-27&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-02-23&quot;, 15 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-31-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_02_23_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="april-26-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">April 26, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/loosening/Scenarios_de_levee_des_mesures_de_freinage_20210426.pdf">Pasteur
report</a>, April 26, 2021. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-9" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-3b-and-3d" class="section level5">
<h5>Fig 3B and 3D</h5>
<p><img src="source_data/2021_04_26/2021_04_26.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-10" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We just apply a slight -39 vertical correction on scenarios curves.
As in the modellers’ original figure (see <em>Original</em> tab), the 2
sets of scenarios split before publication date.</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- -30</code></pre>
<div id="before-correction-10" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_04_26/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2021-04-26&quot;, 1000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-07-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality in Paireau et al.&quot;
) +
  geom_line(
    data=reality_new_hosp_adm, aes(date, new_hosp), alpha=.4, color=&quot;red&quot;
  )  +
  ylim(0, 2000)</code></pre>
<p><img src="index_files/figure-html/2021_04_26_Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-10" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm %&gt;% select(date, new_hosp_smooth), 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-04-26&quot;, 1000, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-07-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;,
  &quot;reality in Paireau et al.&quot;
) +
  geom_line(
    data=reality_new_hosp_adm, aes(date, new_hosp), alpha=.4, color=&quot;red&quot;
  ) +
  ylim(0, 2000)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-33-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% filter(date&lt;=as.Date(&quot;2021-06-15&quot;)) #stop comparison mid-June before delta variant dominant

write_csv(temp,paste0(output_path, &quot;2021_04_26_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-10" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-03-15&quot;, &quot;2021-06-15&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-04-26&quot;, 30 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-34-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_04_26_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="may-21-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">May 21, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/loosening/Mise_a_jour_scenarios_de_levee_des_mesures_de_freinage_20210521.pdf">Pasteur
report</a>, May 21, 2021. Identified on Pasteur Institute’s website, on
<a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-10" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-1a" class="section level5">
<h5>fig 1A</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig1A.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-1c" class="section level5">
<h5>fig 1C</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig1C.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-1e" class="section level5">
<h5>fig 1E</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig1E.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-1g" class="section level5">
<h5>fig 1G</h5>
<p><img src="source_data/2021_05_21/2021_05_21_fig1G.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-11" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-11" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_05_21/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2021-05-21&quot;, 2500, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-06-30&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality in Paireau et al.&quot;
) +
  geom_line(data = reality_new_hosp_adm, aes(date, new_hosp), alpha=.4, color=&quot;red&quot;)</code></pre>
<p><img src="index_files/figure-html/2021_05_21_Pasteur_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-11" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm %&gt;% select(date, new_hosp_smooth), 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-05-21&quot;, 2500, #publication date label
  &quot;2021-01-15&quot;, &quot;2021-06-30&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality in Paireau et al.&quot;
) +
  geom_line(data = reality_new_hosp_adm, aes(date, new_hosp), alpha=.4, color=&quot;red&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-36-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% filter(date&lt;=as.Date(&quot;2021-06-15&quot;)) #stop comparison mid-June before delta variant dominant 

write_csv(temp, paste0(output_path, &quot;2021_05_21_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-11" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-03-15&quot;, &quot;2021-06-15&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-05-21&quot;, 10 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-37-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_05_21_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="july-26-2021-1"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">July 26, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/Institut_Pasteur_Acceleration_vaccination_et_Delta_20210726.pdf">Pasteur
report</a>, July 26, 2021. Identified on Pasteur Institute’s website, on
<a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-11" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-3-zoomes" class="section level5">
<h5>Fig 3 zoomes</h5>
<pre class="r"><code>knitr::include_graphics(&quot;source_data/2021_07_26/2021_07_26_fig3_zoom.png&quot;)</code></pre>
<p><img src="source_data/2021_07_26/2021_07_26_fig3_zoom.png" width="244" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-3-all" class="section level5">
<h5>Fig 3 all</h5>
<pre class="r"><code>knitr::include_graphics(&quot;source_data/2021_07_26/2021_07_26_fig3.png&quot;)</code></pre>
<p><img src="source_data/2021_07_26/2021_07_26_fig3.png" width="372" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-12"
class="section level4 tabset tabset-fade tabset-pills">
<h4 class="tabset tabset-fade tabset-pills">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-12" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_07_26/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2021-07-26&quot;, 3500, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality&quot;
)</code></pre>
<p><img src="index_files/figure-html/2021_07_26_Pasteur_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-12" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm, 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-07-26&quot;, 3500, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-41-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2021_07_26_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-12" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-07-15&quot;, &quot;2021-10-10&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-07-26&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-42-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_07_26_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="august-5-2021-1"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">August 5, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/InstitutPasteur_Dynamiques_regionales_des_hospitalisations_20210805.pdf">Pasteur
report</a>, August 5, 2021. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/delta-variant-dynamic/">this
page</a>.</p>
<div id="original-12" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-a" class="section level5">
<h5>Fig A</h5>
<p><img src="source_data/2021_08_05/2021_08_05_A.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="fig-c" class="section level5">
<h5>Fig C</h5>
<p><img src="source_data/2021_08_05/2021_08_05_C.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-13" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0 
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-13" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_08_05/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2021-08-05&quot;, 1500, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality&quot;
) </code></pre>
<p><img src="index_files/figure-html/2021_08_05_Pasteur_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-13" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm, 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-08-05&quot;, 1500, #publication date label
  &quot;2021-06-15&quot;, &quot;2021-10-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions&quot;, 
  &quot;reality&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-44-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2021_08_05_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-13" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-07-15&quot;, &quot;2021-10-10&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-08-05&quot;, 50 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-45-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_08_05_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="october-4-2021"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">October 4, 2021</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/scenarios/InstitutPasteur_scenariosCOVID19AutomneHiver_2021.pdf">Pasteur
report</a>, October 4, 2021. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/fall-winter-scenarios/">this
page</a>.</p>
<div id="original-13" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="fig-9" class="section level5">
<h5>Fig 9</h5>
<p><img src="source_data/2021_10_04/2021_10_04.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-14" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-14" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2021_10_04/new_hosp.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))

f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2021-10-04&quot;, 1000, #publication date label
  &quot;2021-07-01&quot;, &quot;2022-01-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions beds&quot;, 
  &quot;reality&quot;
)</code></pre>
<p><img src="index_files/figure-html/2021-10-10%20Pasteur-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-14" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm, 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2021-10-04&quot;, 1000, #publication date label
  &quot;2021-07-01&quot;, &quot;2022-01-01&quot;, #date limits
  NA, # y limits
  &quot;daily hospital admissions beds&quot;, 
  &quot;reality&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-47-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>temp &lt;- temp %&gt;% filter(date &lt;= as.Date(&quot;2021-12-15&quot;)) #stop comparison before Omicron dominance in mid-December

write_csv(temp, paste0(output_path, &quot;2021_10_04_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-14" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-09-15&quot;, &quot;2021-12-20&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2021-10-04&quot;, -10 #publication date label
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-48-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2021_10_04_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
<div id="january-7-2022-1"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">January 7, 2022</h3>
<p>Source: <a
href="https://modelisation-covid19.pasteur.fr/variant/InstitutPasteur_Complement_Analyse_Impact_Omicron_20220107_corrige.pdf">Pasteur
report</a>, January 7, 2022. Identified on Pasteur Institute’s website,
on <a
href="https://modelisation-covid19.pasteur.fr/realtime-analysis/omicron-variant-epidemic/">this
page</a>.</p>
<div id="original-14" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Original</h4>
<div id="figure-4-zoomed-1" class="section level5">
<h5>Figure 4 zoomed</h5>
<p><img src="source_data/2022_01_07/2022_01_07_new_hosp_zoom.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="figure-4-all-1" class="section level5">
<h5>Figure 4 all</h5>
<p><img src="source_data/2022_01_07/2022_01_07_new_hosp.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="reproduced-15" class="section level4 tabset tabset-fade">
<h4 class="tabset tabset-fade">Reproduced</h4>
<p>We do not correct the data (no x nor y offset for better
alignment).</p>
<pre class="r"><code>#offset values
x_reality_offset &lt;- 0
y_reality_offset &lt;- 0
x_scenarios_offset &lt;- 0
y_scenarios_offset &lt;- 0</code></pre>
<div id="before-correction-15" class="section level5">
<h5>Before correction</h5>
<pre class="r"><code>scenarios &lt;- read_csv(&quot;source_data/2022_01_07/new_hosp_low_VE.csv&quot;) %&gt;%
  mutate(date = as.Date(date, format = &quot;%Y/%m/%d&quot;, optional = T))


f_graph(
  reality_new_hosp_adm, scenarios, 
  &quot;new_hosp_smooth&quot;,
  &quot;2022-01-07&quot;, 3500, #publication date label
  &quot;2021-12-01&quot;, &quot;2022-04-01&quot;, #date limits
  NA, # y limits
  &quot;daily new hospital admissions&quot;, 
  &quot;reality&quot;
)</code></pre>
<p><img src="index_files/figure-html/2022-01-07_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="after-correction-15" class="section level5">
<h5>After correction</h5>
<pre class="r"><code>temp &lt;- f_offset(
  scenarios, 
  reality_new_hosp_adm, 
  &quot;new_hosp_smooth&quot;
  )

f_graph_corrected(
  temp, 
  &quot;2022-01-07&quot;, 3500, #publication date label
  &quot;2021-12-01&quot;, &quot;2022-04-01&quot;, #date limits
  NA, # y limits
  &quot;daily new hospital admissions&quot;, 
  &quot;reality&quot;
) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-50-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(temp, paste0(output_path, &quot;2022_01_07_new_hosp.csv&quot;))</code></pre>
</div>
</div>
<div id="error-15" class="section level4">
<h4>Error</h4>
<pre class="r"><code>error &lt;- f_compute_error(&quot;2021-12-01&quot;, &quot;2022-04-01&quot;, temp, max_new_hosp)

f_graph_error(
  error,
  &quot;2022-01-07&quot;, 50 #publication date label
  ) +
  xlim(as.Date(NA), as.Date(&quot;2022-02-15&quot;)) #we do not have reality data past Feb 11</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-51-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>write_csv(error, paste0(output_path_error, &quot;2022_01_07_new_hosp_error.csv&quot;))</code></pre>
</div>
</div>
</div>
</div>
<div id="results" class="section level1">
<h1>Results</h1>
<div id="all-reports-grouped"
class="section level2 tabset tabset-fade tabset-pills">
<h2 class="tabset tabset-fade tabset-pills">All reports grouped</h2>
<pre class="r"><code>path_source &lt;- &quot;output_data/extracted_data/&quot;
f_read_ICU &lt;- function(date_scenario){
  
  #get scenario data, add report ID
  data &lt;- read_csv(
    paste0(path_source, &quot;ICU_scenarios/&quot;, date_scenario, &quot;_ICU.csv&quot;)
    ) %&gt;% 
    mutate(report = gsub(&quot;_&quot;, &quot;-&quot;, date_scenario))
  
  #get last date of reality data in report
  temp &lt;- data %&gt;% select(date, reality_report) %&gt;%
    filter(is.na(reality_report)==F)
  begin_date &lt;- max(temp$date)
  
  #keep only data after this date
  data &lt;- data %&gt;%
    filter(date&gt;=begin_date)
  
  return(data)
}

f_read_new_hosp &lt;- function(date_scenario){
  #get scenario data, add report ID
  data &lt;- read_csv(
    paste0(path_source, &quot;new_hosp_scenarios/&quot;, date_scenario, &quot;_new_hosp.csv&quot;)
    ) %&gt;% 
    mutate(report = gsub(&quot;_&quot;, &quot;-&quot;, date_scenario))
  
  #get last date of reality data in report
  temp &lt;- data %&gt;% select(date, reality_report) %&gt;%
    filter(is.na(reality_report)==F)
  begin_date &lt;- max(temp$date)
  
  #keep only data after this date
  data &lt;- data %&gt;%
    filter(date&gt;=begin_date)
}

#ICU data
data_ICU_beds &lt;- bind_rows(
  f_read_ICU(&quot;2020_10_30&quot;),
  f_read_ICU(&quot;2021_05_21&quot;),
  f_read_ICU(&quot;2021_07_26&quot;),
  f_read_ICU(&quot;2021_08_05&quot;),
  f_read_ICU(&quot;2022_01_07&quot;)
)
#1st scenario only Ile de France region
data_ICU_beds_IDF &lt;- f_read_ICU(&quot;2020_04_28&quot;)


data_new_hosp &lt;- bind_rows(
  f_read_new_hosp(&quot;2021_01_16&quot;),
  f_read_new_hosp(&quot;2021_02_02&quot;),
  f_read_new_hosp(&quot;2021_02_08&quot;),
  f_read_new_hosp(&quot;2021_02_23&quot;),
  f_read_new_hosp(&quot;2021_04_26&quot;),
  f_read_new_hosp(&quot;2021_05_21&quot;),
  f_read_new_hosp(&quot;2021_07_26&quot;),
  f_read_new_hosp(&quot;2021_08_05&quot;),
  f_read_new_hosp(&quot;2021_10_04&quot;),
  f_read_new_hosp(&quot;2022_01_07&quot;)
)</code></pre>
<div id="icu-1" class="section level3">
<h3>ICU</h3>
<p>Comparison of all Pasteur Institute’s scenarios on ICU beds occupancy
to reality.</p>
<pre class="r"><code>#prepare dataset

#compute error relative ICU capacity
data_ICU_beds &lt;- data_ICU_beds %&gt;%
  select(
    -c(reality_report)
    ) %&gt;%
  gather(scenario_type, value, -c(date, report, reality)) %&gt;%
  mutate(
    error = round((value-reality)/max_ICU_beds*100)
    ) 
#idem for Ile de France region with its own ICU beds capacity to compute  error
data_ICU_beds_IDF &lt;- data_ICU_beds_IDF %&gt;%
  select(
    -c(reality_report)
    ) %&gt;%
  gather(scenario_type, value, -c(date, report, reality)) %&gt;%
  mutate(
    error = round((value-reality)/max_ICU_beds_IDF*100)
    ) 
#merge the 2 files
data_ICU_beds &lt;- bind_rows(
  data_ICU_beds, 
  data_ICU_beds_IDF
)
rm(data_ICU_beds_IDF)

#max error for colour scale
max_error &lt;- max(data_ICU_beds$error, na.rm = T)

#date of the reports and number of reports
report_dates &lt;- data_frame(
  report = unique(as.Date(data_ICU_beds$report)), #dates of reports
  place = report #to loaclize on x axis
)
#small offset to position summer 2021 reports
report_dates$place[report_dates$place==&quot;2021-07-26&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-07-26&quot;]-15
report_dates$place[report_dates$place==&quot;2021-08-05&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-08-05&quot;]+15
#number of reports
n_reports &lt;- as.numeric(nrow(report_dates))
  




data_ICU_beds &lt;- data_ICU_beds %&gt;%
  mutate(
    days_since_publication = as.numeric(as.Date(date) - as.Date(report)),
    report_date = report,
    report = format(as.Date(report_date), format=&quot;%b %d, %Y&quot;)
  )
dummy &lt;- data_ICU_beds %&gt;% 
  #keep the reality value most close to publication date
  group_by(report) %&gt;%
  filter(
    abs(days_since_publication) == min(abs(days_since_publication))
    ) %&gt;%
  select(
    dummy = reality, report
    ) %&gt;% 
  distinct()
data_ICU_beds &lt;- left_join(data_ICU_beds, dummy, by=&quot;report&quot;) %&gt;%
  mutate(
    error_dummy = case_when(
      # for Apr 28, 2020 scenarios, only in Ile de France (IDF)
      report_date == &quot;2020-04-29&quot; ~ (dummy-reality)/max_ICU_beds_IDF*100,
      T ~ (dummy-reality)/max_ICU_beds*100
    )
  )
rm(dummy)
#reorder report names
data_ICU_beds$report &lt;- factor(
  data_ICU_beds$report,
  levels = c(
    &quot;Apr 28, 2020&quot;,
    &quot;Oct 30, 2020&quot;, 
    &quot;May 21, 2021&quot;, 
    &quot;Jul 26, 2021&quot;, 
    &quot;Aug 05, 2021&quot;, 
    &quot;Jan 07, 2022&quot;
  )
)</code></pre>
<pre class="r"><code>#plot
ggplot(data_ICU_beds) +
   #dates of reports on x axis
  geom_rug(data = report_dates, aes(report)) +
  #dates of reports on x axis
  scale_x_continuous(
    breaks=report_dates$place,
    labels=format(report_dates$report, format=&quot;%b %d, %Y&quot;)
    ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust=1),
    axis.ticks.x=element_blank()
    ) +
  #uncomment to add green shaded area 
  # #margin of error France and Ile-de-France region
  # geom_ribbon(
  #   data=reality_ICU_beds %&gt;% filter(date&gt;=as.Date(&quot;2020-10-01&quot;)),
  #   aes(date, ymin=ICU_beds-max_ICU_beds*1/6 ,ymax=ICU_beds+max_ICU_beds*1/6), 
  #   fill=&quot;green&quot;, alpha=0.2
  #   ) + 
  # geom_ribbon(
  #   data=reality_ICU_beds_IDF %&gt;% filter(date&lt;as.Date(&quot;2020-07-01&quot;)),
  #   aes(date, ymin=ICU_beds-max_ICU_beds_IDF*1/6 ,ymax=ICU_beds+max_ICU_beds_IDF*1/6), 
  #   fill=&quot;green&quot;, alpha=0.2
  #   ) + 
  #scenarios curves and their colours
  geom_line(
    aes(date, value, group=interaction(scenario_type, report), color=abs(error)), 
    linewidth=1.5
    ) +
  scale_colour_stepsn(
    colours = c(&quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;purple&quot;), 
    values = c(0, 15, 30, 100, round(max_error))/max_error,
    breaks = c(0, 15, 30, 100, round(max_error)),
    labels = c(&quot;0%&quot;, &quot;± 15%&quot;, &quot;± 30%&quot;, &quot;± 100%&quot;, &quot;&quot;),
  ) +
  #reality national scale
  geom_line(
    data=reality_ICU_beds %&gt;% filter(date&gt;=as.Date(&quot;2020-10-01&quot;)), 
    aes(date, ICU_beds, linetype=&quot;reality&quot;)) +
  #reality just in Ile-de-France region
  geom_line(
    data=reality_ICU_beds_IDF %&gt;% filter(date&lt;as.Date(&quot;2020-07-01&quot;)), 
    aes(date, ICU_beds)) +
  #1st wave peak in France
  geom_hline(yintercept = max_ICU_beds, linetype=&quot;dashed&quot;) +
  annotate(
    &#39;text&#39;, x = as.Date(&quot;2020-03-01&quot;), y = max_ICU_beds, label = &quot;1st wave peak&quot;, 
    color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, vjust=-.4, hjust=0
    ) + 
  #Ile de France region limits
  geom_rect(
    aes(xmin = as.Date(&quot;2020-03-01&quot;), xmax = as.Date(&quot;2020-08-01&quot;), ymin = 0, ymax = 3000),
    alpha=0, color=&quot;black&quot;, linetype=&quot;dashed&quot;, linewidth=.05
    ) +
  annotate(
    &#39;text&#39;, x = as.Date(&quot;2020-05-15&quot;), y = 3000, label = &quot;Ile-de-France\nregion&quot;, 
    color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, vjust=-.2
    ) + 
  labs(
    x = paste(&quot;publication dates of the&quot;, n_reports, &quot;reports&quot;),
    y=&quot;ICU beds\noccupied by COVID-patients&quot;, x=&quot;&quot;,
    color=&quot;error of scenario\nas % of\n1st wave peak&quot;,
    linetype=&quot;&quot;
  ) </code></pre>
<p><img src="index_files/figure-html/graph_all_ICU-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#save
ggsave(#svg
  &quot;../graphs/all_ICU_scenarios_reality.svg&quot;,
  dpi=500, width=7, height=4, bg=&quot;white&quot;
  )
ggsave(#png
  &quot;../graphs/all_ICU_scenarios_reality.png&quot;,
  dpi=500, width=7, height=4, bg=&quot;white&quot;
  )</code></pre>
</div>
<div id="new-hospitalizations" class="section level3">
<h3>New hospitalizations</h3>
<p>Comparison of all Pasteur Institute’s scenarios on hospital
admissions to reality.</p>
<pre class="r"><code>#prepare data


#compute error relative to 1st wave peak
data_new_hosp &lt;- data_new_hosp %&gt;%
  select(
    -c(reality_report)
    ) %&gt;%
  gather(scenario_type, value, -c(date, report, reality)) %&gt;%
  mutate(
    error = round((value-reality)/max_new_hosp*100)
    ) 
#max error for colour scale
max_error &lt;- max(data_new_hosp$error, na.rm = T)

#date of the reports
report_dates &lt;- data_frame(
  report = unique(as.Date(data_new_hosp$report)),
  place = report #to loaclize on x axis
)
#small offset to position summer 2021 reports
report_dates$place[report_dates$place==&quot;2021-07-26&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-07-26&quot;]-10
report_dates$place[report_dates$place==&quot;2021-08-05&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-08-05&quot;]+3
#small offset to position winter 2021 reports
report_dates$place[report_dates$place==&quot;2021-01-16&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-01-16&quot;]-10
report_dates$place[report_dates$place==&quot;2021-02-02&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-02&quot;]-5
report_dates$place[report_dates$place==&quot;2021-02-08&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-08&quot;]+10
report_dates$place[report_dates$place==&quot;2021-02-23&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-23&quot;]+15
#number of reports
n_reports &lt;- as.numeric(nrow(report_dates))



data_new_hosp &lt;- data_new_hosp %&gt;%
  mutate(
    days_since_publication = as.numeric(as.Date(date) - as.Date(report)),
    report_date = report,
    report = format(as.Date(report_date), format=&quot;%b %d, %Y&quot;)
  )
dummy &lt;- data_new_hosp %&gt;% 
  #keep the reality value most close to publication date
  group_by(report) %&gt;%
  filter(
    abs(days_since_publication) == min(abs(days_since_publication))
    ) %&gt;%
  select(
    dummy = reality, report
    ) %&gt;% 
  distinct()
data_new_hosp &lt;- left_join(data_new_hosp, dummy, by=&quot;report&quot;) %&gt;%
  mutate(
    error_dummy = (dummy-reality)/max_new_hosp*100
    )
rm(dummy)
#reorder report names
data_new_hosp$report &lt;- factor(
  data_new_hosp$report,
  levels = c(
    &quot;Jan 16, 2021&quot;,
    &quot;Feb 02, 2021&quot;, 
    &quot;Feb 08, 2021&quot;, 
    &quot;Feb 23, 2021&quot;, 
    &quot;Apr 26, 2021&quot;, 
    &quot;May 21, 2021&quot;,
    &quot;Jul 26, 2021&quot;, 
    &quot;Aug 05, 2021&quot;, 
    &quot;Oct 04, 2021&quot;,
    &quot;Jan 07, 2022&quot;
  )
)</code></pre>
<pre class="r"><code>#plot
ggplot(data_new_hosp) +
   #dates of reports on x axis
  geom_rug(data = report_dates, aes(report)) +
  #dates of reports on x axis
  scale_x_continuous(
    breaks=report_dates$place,
    labels=format(report_dates$report, format=&quot;%b %d, %Y&quot;),
    limits = c(as.Date(&quot;2021-01-01&quot;), as.Date(&quot;2022-02-12&quot;))
    ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust=1),
    axis.ticks.x=element_blank()
    ) +
  #unsmoothed reality
  geom_line(data=reality_new_hosp_adm, aes(date, new_hosp), alpha=.2) +
  #scenarios curves and their colours
  geom_line(
    aes(date, value, group=interaction(scenario_type, report), color=abs(error)), 
    linewidth=1
    ) +
  scale_colour_stepsn(
    colours = c(&quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;purple&quot;), 
    values = c(0, 15, 30, 100, round(max_error))/max_error,
    breaks = c(0, 15, 30, 100, round(max_error)),
    labels = c(&quot;0%&quot;, &quot;± 15%&quot;, &quot;± 30%&quot;, &quot;± 100%&quot;, &quot;&quot;),
  ) +
  #reality  
  geom_line(data=reality_new_hosp_adm, aes(date, new_hosp_smooth, linetype=&quot;reality&quot;)) +
  #peak 1st wave
  geom_hline(yintercept = max_new_hosp, linetype=&quot;dashed&quot;) +
  annotate(
    &#39;text&#39;, x = as.Date(&quot;2021-04-15&quot;), y = max_new_hosp, label = &quot;1st wave peak&quot;, 
    color = &quot;black&quot;, fontface = &quot;italic&quot;, family = &quot;Times New Roman&quot;, vjust=-.4, hjust=0
    ) + 
  labs(
    x = paste(&quot;publication dates of the&quot;, n_reports, &quot;reports&quot;),
    y=&quot;daily new hospital admissions\nrelated to COVID&quot;, x=&quot;&quot;,
    color=&quot;error of scenario\nerror as % of\n1st wave peak&quot;,
    linetype=&quot;&quot;
  ) +
  ylim(0, 5500)</code></pre>
<p><img src="index_files/figure-html/graph_all_new_hosp-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#save
ggsave(#svg
  &quot;../graphs/all_hosp_scenarios_reality.svg&quot;,
  dpi=500, width=7, height=4, bg=&quot;white&quot;
  )
ggsave(#png
  &quot;../graphs/all_hosp_scenarios_reality.png&quot;,
  dpi=500, width=7, height=4, bg=&quot;white&quot;
  )</code></pre>
</div>
</div>
<div id="short-term-changes" class="section level2">
<h2>Short-term changes</h2>
<p>In some cases the reports are published just a few weeks apart. In
theses cases we compare the short-term changes in the scenarios
dynamics. The 3 case studies are a) winter 2021, b) spring 2021, c)
summer 2021.</p>
<pre class="r"><code>#function for short-term scenarios changes
f_graph_short_term_changes &lt;- 
  function(
    reports, #a string vector of the reports to select
    date_min, date_max #x limits of the graph
    ){
    
    #data frame for vertical lines showing publication dates
    temp &lt;- data_frame(
      report = reports, x = as.Date(reports, format = &quot;%b %d, %Y&quot;)
    )

    #keep only reports of interest
    temp2 &lt;- data_new_hosp %&gt;% filter(report %in% reports)
    
    #chronologically order reports
    temp2$report &lt;- factor(temp2$report, levels=reports)
    temp$report &lt;- factor(temp$report, levels=reports)

    #graph
    g &lt;- ggplot(temp2) +
      geom_line(
        aes(date, value, group=scenario_type, color=&quot;scenarios&quot;), 
        linewidth=1
        ) +
      geom_line(
        data = reality_new_hosp_adm,
        aes(date, new_hosp, color=&quot;reality&quot;), 
        alpha=.2
        ) +
      geom_line(
        data = reality_new_hosp_adm,
        aes(date, new_hosp_smooth, color=&quot;reality&quot;), 
        linewidth=1
        ) +
      geom_vline(data = temp, aes(xintercept = x), linetype=&quot;dashed&quot;) +
      facet_wrap(vars(report), nrow=1) +
      scale_color_manual(values=c(&#39;#ff0000&#39;,&#39;#D8D8D8&#39;)) +
      labs(
        x=&quot;&quot;, y=&quot;hospital admissions&quot;, color=&quot;&quot;
      )
    
    return(g)
  }

g1 &lt;- 
  f_graph_short_term_changes(
    c(&quot;Jan 16, 2021&quot;, &quot;Feb 02, 2021&quot;, &quot;Feb 08, 2021&quot;, &quot;Feb 23, 2021&quot;)
    ) +
  xlim(as.Date(&quot;2021-01-01&quot;), as.Date(&quot;2021-03-25&quot;)) +
  ylim(0, 3000) +
  theme(legend.position = &quot;none&quot;) +
  labs(
    subtitle = &quot;vertical line: publication date&quot;
  )

g2 &lt;- 
  f_graph_short_term_changes(
    c(&quot;Apr 26, 2021&quot;, &quot;May 21, 2021&quot;)
    ) +
  xlim(as.Date(&quot;2021-04-01&quot;), as.Date(&quot;2021-06-15&quot;)) +
  ylim(0, 2100) +
  theme(legend.position = &quot;none&quot;)

g3 &lt;- 
  f_graph_short_term_changes(
    c(&quot;Jul 26, 2021&quot;, &quot;Aug 05, 2021&quot;)
    ) +
  xlim(as.Date(&quot;2021-07-15&quot;), as.Date(&quot;2021-10-01&quot;)) +
  ylim(0, NA) +
  theme(
    legend.position = c(0.9, 0.8),
    legend.background = element_rect(fill=&quot;transparent&quot;)
    ) 

plot_grid(
  g1,
  plot_grid(
    g2, g3, nrow=1, labels=(c(&quot;b&quot;, &quot;c&quot;))
  ), 
  nrow = 2, labels=c(&quot;a&quot;, &quot;&quot;)
)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-52-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#save
ggsave(#svg
  &quot;../graphs/short_term_changes.svg&quot;,
  dpi=500, width=7, height=5, bg=&quot;white&quot;
  )
ggsave(#png
  &quot;../graphs/short_term_changes.png&quot;,
  dpi=500, width=8, height=5, bg=&quot;white&quot;
  )</code></pre>
</div>
<div id="all-errors-grouped"
class="section level2 tabset tabset-fade tabset-pills">
<h2 class="tabset tabset-fade tabset-pills">All errors grouped</h2>
<pre class="r"><code>path_source &lt;- &quot;output_data/min_med_max_and_error/&quot;

f_read_ICU_error &lt;- function(date_scenario){
  
  #get scenario data, add report ID
  data &lt;- read_csv(
    paste0(path_source, &quot;ICU_error/&quot;, date_scenario, &quot;_ICU_error.csv&quot;)
    ) %&gt;% 
    mutate(report = gsub(&quot;_&quot;, &quot;-&quot;, date_scenario))
  
  data &lt;- data %&gt;% select(report, date, error_min, error_med, error_max) %&gt;%
    filter(
      is.na(error_min)==F &amp; is.na(error_med)==F &amp; is.na(error_max)==F
      ) %&gt;%
    mutate(
      days_since_publication = as.Date(date)-as.Date(report)
      ) 
  
  return(data)
}

f_read_new_hosp_error &lt;- function(date_scenario){
  #get scenario data, add report ID
  data &lt;- read_csv(
    paste0(path_source, &quot;new_hosp_error/&quot;, date_scenario, &quot;_new_hosp_error.csv&quot;)
    ) %&gt;% 
    mutate(report = gsub(&quot;_&quot;, &quot;-&quot;, date_scenario))
  
  data &lt;- data %&gt;% select(report, date, error_min, error_med, error_max) %&gt;%
    filter(
      is.na(error_min)==F &amp; is.na(error_med)==F &amp; is.na(error_max)==F
      ) %&gt;%
    mutate(
      days_since_publication = as.Date(date)-as.Date(report)
      ) 
  
  return(data)
}

#ICU data
data_ICU_error &lt;- bind_rows(
  f_read_ICU_error(&quot;2020_04_28&quot;),
  f_read_ICU_error(&quot;2020_10_30&quot;),
  f_read_ICU_error(&quot;2021_05_21&quot;),
  f_read_ICU_error(&quot;2021_07_26&quot;),
  f_read_ICU_error(&quot;2021_08_05&quot;),
  f_read_ICU_error(&quot;2022_01_07&quot;)
)

#new hosp data
data_new_hosp_error &lt;- bind_rows(
  f_read_new_hosp_error(&quot;2021_01_16&quot;),
  f_read_new_hosp_error(&quot;2021_02_02&quot;),
  f_read_new_hosp_error(&quot;2021_02_08&quot;),
  f_read_new_hosp_error(&quot;2021_02_23&quot;),
  f_read_new_hosp_error(&quot;2021_04_26&quot;),
  f_read_new_hosp_error(&quot;2021_05_21&quot;),
  f_read_new_hosp_error(&quot;2021_07_26&quot;),
  f_read_new_hosp_error(&quot;2021_08_05&quot;),
  f_read_new_hosp_error(&quot;2021_10_04&quot;),
  f_read_new_hosp_error(&quot;2022_01_07&quot;)
) </code></pre>
<pre class="r"><code>temp &lt;- bind_rows(
  data_ICU_error %&gt;% mutate(variable = &quot;ICU&quot;),
  data_new_hosp_error  %&gt;% mutate(variable = &quot;new hosp&quot;)
) %&gt;% 
  gather(min_med_max, error_perc, error_min, error_med, error_max)
  
max_error &lt;- max(temp$error_perc, na.rm = T)
ggplot(temp) +
  geom_line(
    aes(days_since_publication, error_perc, color=abs(error_perc), group=report),
    linewidth=1
    ) +
  geom_vline(xintercept = 0, linetype=&quot;dashed&quot;) +
  scale_colour_stepsn(
    colours = c(&quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;purple&quot;), 
    values = c(0, 15, 30, 100, max_error)/max_error,
    breaks = c(0, 15, 30, 100, max_error),
    labels = c(&quot;0%&quot;, &quot;± 15%&quot;, &quot;± 30%&quot;, &quot;± 100%&quot;, &quot;&quot;),
  ) +
  facet_grid(variable~min_med_max) +
  ylim(NA, 100) +
  xlim(-20, NA)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-54-1.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(temp %&gt;% filter(variable==&quot;ICU&quot;)) +
  geom_line(
    aes(days_since_publication, error_perc, color=abs(error_perc), group=report),
    linewidth=1
    ) +
  scale_colour_stepsn(
    colours = c(&quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;purple&quot;), 
    values = c(0, 15, 30, 100, max_error)/max_error,
    breaks = c(0, 15, 30, 100, max_error),
    labels = c(&quot;0%&quot;, &quot;± 15%&quot;, &quot;± 30%&quot;, &quot;± 100%&quot;, &quot;&quot;)
  ) +
  facet_grid(min_med_max~report) +
  ylim(-100, 150) + xlim(-20, NA)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-54-2.svg" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(
  temp %&gt;% 
    filter(variable==&quot;new hosp&quot;)
  ) +
  geom_line(
    aes(days_since_publication, error_perc, color=abs(error_perc), group=report),
    linewidth=1
    ) +
  scale_colour_stepsn(
    colours = c(&quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;purple&quot;), 
    values = c(0, 15, 30, 100, max_error)/max_error,
    breaks = c(0, 15, 30, 100, max_error)
  ) +
  facet_grid(min_med_max~report) +
  ylim(-100, 150) + xlim(-20, NA)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-54-3.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="individual-report-and-error"
class="section level2 tabset tabset-fade tabset-pills">
<h2 class="tabset tabset-fade tabset-pills">Individual report and
error</h2>
<div id="individual-comparison"
class="section level3 tabset tabset-fade">
<h3 class="tabset tabset-fade">Individual Comparison</h3>
<div id="icu-beds" class="section level4">
<h4>ICU beds</h4>
<pre class="r"><code>ggplot(data_ICU_beds) +
  #scenarios
  geom_line(
    aes(date, value, group=interaction(scenario_type, report), color=&quot;report scenarios&quot;), 
    linewidth=1.5
    ) +
  #reality national scale
  geom_line(
    aes(date, reality, linetype=&quot; reality&quot;)
    ) +
  #dummy baseline
  geom_line(
    aes(date, dummy, linetype=&quot;constant dummy baseline&quot;)
    ) +
  ylim(0, NA) +
  facet_wrap(vars(report), scales=&quot;free&quot;) +
  labs(
    title = &quot;Pasteur Institute scenarios during COVID-19\nIntensive Care Units&quot;,
    y=&quot;ICU beds\noccupied by COVID-patients&quot;, x=&quot;&quot;,
    linetype=&quot;&quot;,
    color=&quot;&quot;
  ) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-55-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="hospital-admissions-1" class="section level4">
<h4>Hospital Admissions</h4>
<pre class="r"><code>ggplot(data_new_hosp) +
  #scenarios
  geom_line(
    aes(date, value, group=interaction(scenario_type, report), color=&quot;report scenarios&quot;), 
    linewidth=1.5
    ) +
  #reality national scale
  geom_line(
    aes(date, reality, linetype=&quot; reality&quot;)
    ) +
  #dummy baseline
  geom_line(
    aes(date, dummy, linetype=&quot;constant dummy baseline&quot;)
    ) +
  ylim(0, NA) +
  facet_wrap(vars(report), scales=&quot;free&quot;) +
  labs(
    title = &quot;Pasteur Institute scenarios during COVID-19\nHospital Admissions&quot;,
    y=&quot;daily new hospital admissions\nrelated to COVID&quot;, x=&quot;&quot;,
    linetype=&quot;&quot;,
    color=&quot;&quot;
  ) </code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-56-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="error-16"
class="section level3 tabset tabset-fade tabset-pills">
<h3 class="tabset tabset-fade tabset-pills">Error</h3>
<div id="icu-2" class="section level4">
<h4>ICU</h4>
<pre class="r"><code>ggplot(data_ICU_beds) +
  geom_line(aes(days_since_publication, error, color = &quot;Pasteur&#39;s scenarios&quot;, group=scenario_type)) +
  geom_line(aes(days_since_publication, error_dummy, color=&quot;dummy variable&quot;)) +
  facet_wrap(vars(report)) +
  geom_hline(yintercept = 0, linetype=&quot;dashed&quot;) +
  ylim(-50, 150) +
  labs(
    y=&quot;error to reality as % of 1st wave peak&quot;,
    x=&quot;number of days since report publication&quot;,
    color=&quot;&quot;
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-57-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="hospital-admissions-2" class="section level4">
<h4>Hospital Admissions</h4>
<pre class="r"><code>ggplot(data_new_hosp) +
  geom_line(aes(days_since_publication, error, color = &quot;Pasteur&#39;s scenarios&quot;, group=scenario_type)) +
  geom_line(aes(days_since_publication, error_dummy, color=&quot;dummy variable&quot;)) +
  facet_wrap(vars(report)) +
  geom_hline(yintercept = 0, linetype=&quot;dashed&quot;) +
  ylim(-50, 150) +
  labs(
    y=&quot;error to reality as % of 1st wave peak&quot;,
    x=&quot;number of days since report publication&quot;,
    color=&quot;&quot;
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-58-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="cumulative-error"
class="section level2 tabset tabset-fade tabset-pills">
<h2 class="tabset tabset-fade tabset-pills">Cumulative Error</h2>
<div id="rmse" class="section level3">
<h3>RMSE</h3>
<pre class="r"><code>#RMSE Mean Error for each ICU report (optimist, median and pessimist scenario)
rmse_ICU &lt;- data_ICU_error %&gt;%
  group_by(report) %&gt;%
  filter(date&gt;report) %&gt;%
  summarise(
    optimist =  round(sqrt(sum(error_min^2)/length(which(!is.na(error_min))))),
    median =  round(sqrt(sum(error_med^2)/length(which(!is.na(error_med))))),
    pessimist =  round(sqrt(sum(error_max^2)/length(which(!is.na(error_max)))))
  )
#RMSE Mean Error for each hospital admissions report (optimist, median and pessimist scenario)
rmse_hosp &lt;- data_new_hosp_error %&gt;%
  group_by(report) %&gt;%
  filter(date&gt;report) %&gt;%
  summarise(
    optimist =  round(sqrt(sum(error_min^2)/length(which(!is.na(error_min))))),
    median =  round(sqrt(sum(error_med^2)/length(which(!is.na(error_med))))),
    pessimist =  round(sqrt(sum(error_max^2)/length(which(!is.na(error_max)))))
  )
#combine ICU and hospital admissions RMSE
rmse &lt;- bind_rows(
  rmse_ICU %&gt;% mutate(variable = &quot;ICU&quot;), 
  rmse_hosp %&gt;% mutate(variable = &quot;hospital admissions&quot;)
  ) %&gt;% 
  mutate(report = as.Date(report))
rm(rmse_ICU, rmse_hosp)

#date of the reports, to position on the graph
report_dates &lt;- data_frame(
  report = unique(as.Date(rmse$report)),
  place = report #to localize on x axis
)
#small offset to position summer 2021 reports
report_dates$place[report_dates$place==&quot;2021-07-26&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-07-26&quot;]-10
report_dates$place[report_dates$place==&quot;2021-08-05&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-08-05&quot;]+3
#small offset to position winter 2021 reports
report_dates$place[report_dates$place==&quot;2021-01-16&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-01-16&quot;]-10
report_dates$place[report_dates$place==&quot;2021-02-02&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-02&quot;]-5
report_dates$place[report_dates$place==&quot;2021-02-08&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-08&quot;]+10
report_dates$place[report_dates$place==&quot;2021-02-23&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-23&quot;]+15

#graph
ggplot(rmse) +
  geom_point(
    aes(report, median)
    ) +
  geom_errorbar(
    aes(x = report, ymin = optimist, ymax = pessimist),
    width=.2
    ) +
  facet_wrap(vars(variable), nrow = 2) +
  ylim(0, 100) +
  #dates of reports on x axis
  scale_x_continuous(
    breaks=report_dates$place,
    labels=format(report_dates$report, format=&quot;%b %d, %Y&quot;)
    ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust=1),
    axis.ticks.x=element_blank()
    ) +
  labs(
    x=&quot;report date&quot;, y=&quot;RMSE, % of historical peak&quot;,
    subtitle = &quot;point: median scenario       error bar: range of all scenarios&quot;
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-59-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="mean-error" class="section level3">
<h3>Mean Error</h3>
<pre class="r"><code>#ME Mean Error for each ICU report (optimist, median and pessimist scenario)
ME_ICU &lt;- data_ICU_error %&gt;%
  group_by(report) %&gt;%
  filter(date&gt;report) %&gt;%
  summarise(
    optimist =  round(sum(error_min)/length(which(!is.na(error_min)))),
    median =  round(sum(error_med)/length(which(!is.na(error_med)))),
    pessimist =  round(sum(error_max)/length(which(!is.na(error_max))))
  )
#ME Mean Error for each hospital admissions report (optimist, median and pessimist scenario)
ME_hosp &lt;- data_new_hosp_error %&gt;%
  group_by(report) %&gt;%
  filter(date&gt;report) %&gt;%
  summarise(
    optimist =  round(sum(error_min)/length(which(!is.na(error_min)))),
    median =  round(sum(error_med)/length(which(!is.na(error_med)))),
    pessimist =  round(sum(error_max)/length(which(!is.na(error_max))))
  )
#combine ICU and hospital admissions ME
ME &lt;- bind_rows(
  ME_ICU %&gt;% mutate(variable = &quot;ICU&quot;), 
  ME_hosp %&gt;% mutate(variable = &quot;hospital admissions&quot;)
  ) %&gt;% 
  mutate(report = as.Date(report))
rm(ME_ICU, ME_hosp)

#date of the reports, to position on the graph
report_dates &lt;- data_frame(
  report = unique(as.Date(ME$report)),
  place = report #to localize on x axis
)
#small offset to position summer 2021 reports
report_dates$place[report_dates$place==&quot;2021-07-26&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-07-26&quot;]-10
report_dates$place[report_dates$place==&quot;2021-08-05&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-08-05&quot;]+3
#small offset to position winter 2021 reports
report_dates$place[report_dates$place==&quot;2021-01-16&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-01-16&quot;]-10
report_dates$place[report_dates$place==&quot;2021-02-02&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-02&quot;]-5
report_dates$place[report_dates$place==&quot;2021-02-08&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-08&quot;]+10
report_dates$place[report_dates$place==&quot;2021-02-23&quot;] &lt;- report_dates$place[report_dates$place==&quot;2021-02-23&quot;]+15

#graph
ggplot(ME) +
  geom_point(
    aes(report, median)
    ) +
  geom_errorbar(
    aes(x = report, ymin = optimist, ymax = pessimist),
    width=.2
    ) +
  facet_wrap(vars(variable), nrow = 2) +
  ylim(-100, 100) + #dates of reports on x axis
  #dates of reports on x axis
  scale_x_continuous(
    breaks=report_dates$place,
    labels=format(report_dates$report, format=&quot;%b %d, %Y&quot;)
    ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust=1),
    axis.ticks.x=element_blank()
    ) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, alpha=.5) +
  labs(
    x=&quot;report date&quot;, y=&quot;mean error, % of historical peak&quot;,
    subtitle = &quot;point: median scenario       error bar: range of all scenarios&quot;
  )</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-60-1.svg" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
